<!DOCTYPE html>
<html lang="en">
<head>
    <title>Camera</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script
    src="https://code.jquery.com/jquery-1.12.4.min.js"
    integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
    crossorigin="anonymous"></script>
    <script src="/static/jsmpeg.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.css">
</head>
<body>
    <h2>
        rtsp://viewer:laguna2018@TranqueraCLER.dahuaddns.com:554/cam/realmonitor?channel=1&subtype=1&unicast=true&proto=Onvif
    </h2>
    <p id="loading"></p>
    <p id="stop"></p>

    <div class="columns">
        <div class="column" style="margin-left: 60px;">
            <canvas id="camera1"></canvas>
            <div>
                <button id="stop" onclick="stop('camera1')">Stop</button>
                <button id="start" onclick="start('camera1')">Start</button>
            </div>
        </div>
        <div class="column">
            <canvas id="camera2"></canvas>
            <div>
                <button id="stop" onclick="stop('camera2')">Stop</button>
                <button id="start" onclick="start('camera2')">Start</button>
            </div>
        </div>
        <div class="column">
            <canvas id="camera3"></canvas>
            <div>
                <button id="stop" onclick="stop('camera3')">Stop</button>
                <button id="start" onclick="start('camera3')">Start</button>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="is-offset-1 column">
            <canvas id="camera4"></canvas>
            <div>
                <button id="stop" onclick="stop('camera4')">Stop</button>
                <button id="start" onclick="start('camera4')">Start</button>
            </div>
        </div>
        <div class="column">
            <canvas id="camera5"></canvas>
            <div>
                <button id="stop" onclick="stop('camera5')">Stop</button>
                <button id="start" onclick="start('camera5')">Start</button>
            </div>
        </div>
    </div>
</body>
    <script>

        function stop(camera){
            $('#stop').text(`Stopped ${ camera }`)
            setTimeout(() => {
                $.ajax({     
                    url: "/stream/stop",
                    type: "POST",
                    data: JSON.stringify({ name: camera }),
                    success: () => {
                        $('#stop').text("")
                    },
                    dataType: 'json',
                    contentType : 'application/json',
                    headers: {
                        "Authorization": "Basic " + btoa('admin:admin')
                    }
                })
            }, 2000)
        }

        function start(camera) {
            $('#loading').text("Loading...")
            setTimeout(() => {
                $.ajax({     
                    url: "/stream",
                    type: "POST",
                    data: JSON.stringify({
                        name: camera,
                        duration: 30,
                        uri: "rtsp://Remote:Chacra-2019@chacra16.dahuaddns.com:554/cam/realmonitor?channel=1&subtype=1&unicast=true&proto=Onvif",
                    }),
                    success: (res) => {
                        console.log("Streaming...")
                        $('#loading').text("")
                        new JSMpeg.Player(
                            `ws://localhost:${res.port}/${res.token}`,
                            { canvas: document.getElementById(camera), reconnectInterval: 0 }
                        )
                    },
                    dataType: 'json',
                    contentType : 'application/json',
                    headers: {
                        "Authorization": "Basic " + btoa('admin:admin')
                    }
                })
            }, 2000)
        }
    </script>
</html>